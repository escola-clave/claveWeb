generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum UserRole {
  ADMIN
  TEACHER
  STUDENT // Anteriormente era ARTIST no mock, mas STUDENT √© mais gen√©rico
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum CourseType {
  MUSIC
  THEATER
}

enum SeasonStatus {
  PLANNED
  ACTIVE
  CLOSED
}

enum ProjectType {
  ALBUM
  PLAY
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  UPCOMING
}

enum TrackSceneStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TrackMaterialType {
  PDF
  AUDIO
  VIDEO // Adicionado para v√≠deos de aula
  TEXT
  LINK
}

// REMOVIDO: enum StudyTrackType - agora ser√° String customiz√°vel
//
// STUDY TRACK CATEGORIES (TIPOS CUSTOMIZ√ÅVEIS)
// Define os tipos de faixas de estudo que podem ser criados
// Permite que cada escola/curso crie seus pr√≥prios tipos
//

model StudyTrackCategory {
  id          String      @id @default(uuid())
  courseId    String      // Cada curso pode ter suas categorias
  name        String      // Ex: "Harmonia", "Blocking", "Express√£o Corporal"
  key         String      // Chave √∫nica: "HARMONY", "BLOCKING", "BODY_EXPRESSION"
  icon        String?     // √çcone opcional: "üéµ", "üé≠", "üíÉ"
  color       String?     // Cor para UI: "#FF5733"
  description String?
  order       Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  course               Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studyTrackTemplates  StudyTrackTemplate[]  // Templates de faixas de estudo

  @@unique([courseId, key])
  @@index([courseId])
  @@index([isActive])
}

//
// STUDY TRACK TEMPLATES (CONTE√öDO DID√ÅTICO REUTILIZ√ÅVEL)
// Templates de faixas de estudo que podem ser reutilizados em m√∫ltiplos semestres
// Vinculados aos TrackSceneTemplates para reuso completo
//

model StudyTrackTemplate {
  id                    String   @id @default(uuid())
  trackSceneTemplateId  String   // Template da m√∫sica/cena
  categoryId            String?  // Categoria opcional
  categoryKey           String?  // Denormalizado: "HARMONY", "BLOCKING"
  title                 String
  description           String?
  technicalNotes        String?  // Notas t√©cnicas pedag√≥gicas
  videoUrl              String?
  audioUrl              String?
  pdfUrl                String?
  order                 Int
  estimatedMinutes      Int      @default(15)
  isRequired            Boolean  @default(true)
  isVisible             Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  trackSceneTemplate  TrackSceneTemplate  @relation(fields: [trackSceneTemplateId], references: [id], onDelete: Cascade)
  category            StudyTrackCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  studyTracks         StudyTrack[]        // Inst√¢ncias criadas deste template

  @@index([trackSceneTemplateId])
  @@index([categoryId])
  @@index([order])
}

//
// STUDY TRACKS (INST√ÇNCIAS DAS FAIXAS DE ESTUDO)
// Inst√¢ncias de faixas de estudo criadas quando um projeto √© instanciado
// Cada turma/semestre tem suas pr√≥prias inst√¢ncias
//

model StudyTrack {
  id               String   @id @default(uuid())
  trackSceneId     String   // Inst√¢ncia da m√∫sica/cena
  templateId       String   // Template original
  categoryId       String?  // Categoria (copiada do template)
  categoryKey      String?  // Denormalizado para performance
  title            String   // Copiado do template (pode ser customizado)
  description      String?
  technicalNotes   String?
  videoUrl         String?  // URLs podem ser diferentes da inst√¢ncia
  audioUrl         String?
  pdfUrl           String?
  order            Int
  estimatedMinutes Int      @default(15)
  isRequired       Boolean  @default(true)
  isVisible        Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  trackScene      TrackScene            @relation(fields: [trackSceneId], references: [id], onDelete: Cascade)
  template        StudyTrackTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  category        StudyTrackCategory?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  studentProgress StudentStudyTrack[]

  @@index([trackSceneId])
  @@index([templateId])
  @@index([categoryId])
  @@index([order])
}

enum StudentTrackSceneStatus {
  LOCKED
  AVAILABLE
  STUDYING
  COMPLETED
}

enum SubmissionStatus {
  PENDING
  PENDING_REVIEW
  REVIEWED
  APPROVED
  NEEDS_REVISION
  REJECTED
}

enum DemoStatus {
  PENDING_REVIEW
  APPROVED
  NEEDS_REVISION
  REJECTED
}

enum ReviewType {
  POSITIVE
  CONSTRUCTIVE
  CRITICAL
}

enum PressResult {
  PASS
  FAIL
}

enum TourStatus {
  ACTIVE
  PAUSED
  BROKEN
  FINISHED
}

enum StreakDayStatus {
  DONE
  MISSED
  PAUSED
}

enum DailyMissionStatus {
  DONE
  DONE_WITH_PENALTY
  SKIPPED
}

enum ClassStudentStatus {
  ACTIVE
  TRANSFERRED
  DROPPED
}

enum DailyMissionTemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ActorType {
  USER
  SYSTEM
  RULE_ENGINE
}

enum StreakEffect {
  INCREMENT
  RESET
  PAUSE
  NO_EFFECT
}

enum AchievementCategory {
  STREAK
  DEMOS
  SOCIAL
  SPECIAL
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ArtistLevel {
  SHOWER
  GARAGE
  UNDERGROUND
  INDIE
  RISING_STAR
  HEADLINER
  MAIN_STAGE
}

//
// IDENTITY
//

model User {
  id                 String     @id @default(uuid())
  name               String
  email              String     @unique
  passwordHash       String
  role               UserRole
  status             UserStatus
  mustChangePassword Boolean
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  notifications  Notification[]
  domainEvents   DomainEvent[]   @relation("ActorEvents")

  @@index([role])
  @@index([status])
  @@index([email])
}

model StudentProfile {
  userId              String   @id
  stageName           String   // Nome art√≠stico (funciona para m√∫sica e teatro)
  avatarUrl           String?
  bio                 String?
  specialization      String?  // Especializa√ß√£o: M√∫sica: "Voz", "Viol√£o" | Teatro: "Interpreta√ß√£o", "Dire√ß√£o"
  genres              String?  // G√™neros/Estilos (JSON array): M√∫sica: ["MPB", "Jazz"] | Teatro: ["Drama", "Com√©dia"]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  classStudents    ClassStudent[]
  tours            Tour[]
  careers          Career[]
  missions         DailyMission[]
  trackScenes      StudentTrackScene[]
  studentStudyTracks StudentStudyTrack[]  // Progresso em faixas de estudo
  submissions      Submission[]
  pressAttempts    PressAttempt[]
  teacherReviews   Review[]         @relation("TeacherReviews")
  fanTransactions  FanTransaction[]
  vacations        Vacation[]
  achievements     StudentAchievement[]
}

model TeacherProfile {
  userId    String   @id
  avatarUrl String?
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes ClassTeacher[]
}

//
// SCHOOL / ACADEMIA
//

model School {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courses Course[]
}

model Course {
  id        String     @id @default(uuid())
  schoolId  String
  name      String
  type      CourseType
  isActive  Boolean
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  school                  School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  seasons                 Season[]
  projectTemplates        ProjectTemplate[]
  dailyMissionTemplates   DailyMissionTemplate[]
  studyTrackCategories    StudyTrackCategory[]   // Categorias customiz√°veis de faixas de estudo
}

model Season {
  id        String       @id @default(uuid())
  courseId  String
  name      String
  startDate DateTime
  endDate   DateTime
  status    SeasonStatus
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  course           Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  classes          Class[]
  projects         Project[]
  careers          Career[]
  tours            Tour[]
  pressQuizzes     PressQuiz[]
  dailyMissions    DailyMission[]
  fanTransactions  FanTransaction[]
  vacations        Vacation[]
}

model Class {
  id          String   @id @default(uuid())
  seasonId    String
  name        String
  maxStudents Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  season              Season           @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  classStudents       ClassStudent[]
  teachers            ClassTeacher[]
  projects            Project[]
}

model ClassTeacher {
  id         String    @id @default(uuid())
  teacherId  String
  classId    String
  joinedAt   DateTime
  leftAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  teacher TeacherProfile @relation(fields: [teacherId], references: [userId], onDelete: Cascade)
  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classId])
}

//
// CLASS ENROLLMENT (AUDIT)
//

model ClassStudent {
  id         String              @id @default(uuid())
  classId    String
  studentId  String
  joinedAt   DateTime
  leftAt     DateTime?
  status     ClassStudentStatus
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@unique([classId, studentId])
}

//
// PROJECT / PEDAGOGY
//

model ProjectTemplate {
  id            String      @id @default(uuid())
  courseId      String
  name          String
  type          ProjectType
  description   String?
  coverImage    String?
  version       Int         @default(1)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  course         Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  projects       Project[]
  trackTemplates TrackSceneTemplate[]
}

model Project {
  id                        String        @id @default(uuid())
  templateId                String
  projectTemplateVersion    Int           @default(1)
  classId                   String
  seasonId                  String
  name                      String
  description               String?
  coverImage                String?
  status                    ProjectStatus
  isVisible                 Boolean       @default(false)
  releasedAt                DateTime?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt

  template   ProjectTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  class      Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  season     Season            @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  tracks     TrackScene[]
}

model TrackSceneTemplate {
  id                    String   @id @default(uuid())
  projectTemplateId     String
  title                 String
  artist                String?
  description           String?
  technicalInstruction  String?
  lyrics                String?
  order                 Int
  unlockAfterTrackId    String?
  demoRequired          Boolean  @default(true)
  pressQuizRequired     Boolean  @default(false)
  version               Int      @default(1)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  projectTemplate   ProjectTemplate         @relation(fields: [projectTemplateId], references: [id], onDelete: Cascade)
  tracks            TrackScene[]
  materials         TrackMaterialTemplate[]
  studyTrackTemplates StudyTrackTemplate[]  // Templates de faixas de estudo reutiliz√°veis
}

model TrackScene {
  id                          String           @id @default(uuid())
  projectId                   String
  templateId                  String
  trackSceneTemplateVersion   Int              @default(1)
  title                       String
  artist                      String?
  description                 String?
  videoUrl                    String?
  technicalInstruction        String?
  lyrics                      String?
  order                       Int
  status                      TrackSceneStatus
  isVisible                   Boolean          @default(false)
  demoRequired                Boolean          @default(true)
  pressQuizRequired           Boolean          @default(false)
  createdAt                   DateTime         @default(now())
  updatedAt                   DateTime         @updatedAt

  project          Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  template         TrackSceneTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  submissions      Submission[]
  studentProgress  StudentTrackScene[]
  materials        TrackMaterial[]
  pressQuizzes     PressQuiz[]
  studyTracks      StudyTrack[]          // Faixas de estudo pedag√≥gicas
}

//
// STUDENT PROGRESS ON STUDY TRACKS
// Acompanha o progresso do aluno em cada faixa de estudo
// NOTA: StudyTrack j√° est√° definido acima (linhas 129-157)
//

model StudentStudyTrack {
  id            String    @id @default(uuid())
  studentId     String
  studyTrackId  String
  completed     Boolean   @default(false)
  completedAt   DateTime?
  notes         String?   // Notas do aluno sobre esta faixa
  practiceTime  Int       @default(0) // Tempo de pr√°tica em minutos
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  student    StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  studyTrack StudyTrack     @relation(fields: [studyTrackId], references: [id], onDelete: Cascade)

  @@unique([studentId, studyTrackId])
  @@index([studentId])
  @@index([studyTrackId])
  @@index([completed])
}

//
// TRACK MATERIALS (TEMPLATES & INSTANCES)
//

model TrackMaterialTemplate {
  id                    String               @id @default(uuid())
  trackSceneTemplateId  String
  type                  TrackMaterialType
  title                 String
  defaultContentUrl     String?
  defaultTextContent    String?
  order                 Int
  isRequired            Boolean              @default(false)
  version               Int                  @default(1)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  template  TrackSceneTemplate  @relation(fields: [trackSceneTemplateId], references: [id], onDelete: Cascade)
  materials TrackMaterial[]
}

model TrackMaterial {
  id                          String               @id @default(uuid())
  templateId                  String?
  trackSceneId                String
  trackMaterialTemplateVersion Int                 @default(1)
  type                        TrackMaterialType
  title                       String
  contentUrl                  String?
  textContent                 String?
  order                       Int
  isVisible                   Boolean              @default(false)
  createdAt                   DateTime             @default(now())
  updatedAt                   DateTime             @updatedAt

  template   TrackMaterialTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  trackScene TrackScene             @relation(fields: [trackSceneId], references: [id], onDelete: Cascade)
}

//
// STUDENT PROGRESS TRACKING
//

model StudentTrackScene {
  id          String                   @id @default(uuid())
  studentId   String
  trackSceneId String
  status      StudentTrackSceneStatus
  completedAt DateTime?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt

  student    StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  trackScene TrackScene     @relation(fields: [trackSceneId], references: [id], onDelete: Cascade)

  @@unique([studentId, trackSceneId])
  @@index([studentId, status])
}

//
// ROUTINE / DAILY MISSIONS
//

model DailyMissionTemplate {
  id        String   @id @default(uuid())
  courseId  String
  title     String
  description String?
  videoUrl  String?
  order     Int
  status    DailyMissionTemplateStatus @default(DRAFT)
  isActive  Boolean                    @default(false)
  createdAt DateTime                   @default(now())
  updatedAt DateTime                   @updatedAt

  course       Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  missions     DailyMission[]
  quizzes      DailyMissionQuiz[]
  exercises    DailyMissionExercise[]
}

model DailyMissionExercise {
  id                   String   @id @default(uuid())
  dailyMissionTemplateId String
  title                String
  description          String?
  videoUrl             String?
  duration             Int
  order                Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  template DailyMissionTemplate @relation(fields: [dailyMissionTemplateId], references: [id], onDelete: Cascade)
}

model DailyMissionQuiz {
  id                   String   @id @default(uuid())
  dailyMissionId       String
  version              Int      @default(1)
  questionsJson        Json?
  maxAttemptsPerDay    Int      @default(1)
  allowRecoveryAttempt Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  mission DailyMissionTemplate @relation(fields: [dailyMissionId], references: [id], onDelete: Cascade)
}

model DailyMission {
  id         String             @id @default(uuid())
  templateId String
  studentId  String
  seasonId   String
  date       DateTime           @db.Date
  status     DailyMissionStatus @default(DONE)
  attemptsCount Int              @default(0)
  completed     Boolean          @default(false)
  completedAt   DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  template DailyMissionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  student  StudentProfile       @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  season   Season               @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([studentId, status])
  @@index([date])
  @@index([seasonId])
}

//
// STUDIO / SUBMISSION
//

model Submission {
  id              String           @id @default(uuid())
  studentId       String
  trackSceneId    String
  attemptNumber   Int              @default(1)
  mediaUrl        String?
  notes           String?
  status          SubmissionStatus
  pressUnlocked   Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  reviewedAt      DateTime?

  student StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  track   TrackScene     @relation(fields: [trackSceneId], references: [id], onDelete: Cascade)
  reviews Review[]
  pressAttempts PressAttempt[]

  @@index([studentId])
  @@index([trackSceneId])
  @@index([status])
  @@index([createdAt])
}

//
// REVIEW (FEEDBACK)
//

model Review {
  id           String     @id @default(uuid())
  submissionId String
  teacherId    String
  teacherName  String
  type         ReviewType
  rating       Float?
  comment      String?
  feedback     String?
  technicalNotes String?
  approved     Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  submission Submission     @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  teacher    StudentProfile @relation("TeacherReviews", fields: [teacherId], references: [userId], onDelete: Cascade)
}

//
// PRESS
//

model PressQuiz {
  id              String   @id @default(uuid())
  trackSceneId    String
  seasonId        String
  version         Int      @default(1)
  questionsJson   Json?
  maxAttempts     Int      @default(3)
  passingScore    Int      @default(70)
  status          TrackSceneStatus @default(DRAFT)
  isActive        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  trackScene TrackScene       @relation(fields: [trackSceneId], references: [id], onDelete: Cascade)
  season     Season           @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  attempts   PressAttempt[]

  @@index([trackSceneId])
  @@index([seasonId])
}

model PressAttempt {
  id            String      @id @default(uuid())
  studentId     String
  submissionId  String
  pressQuizId   String
  attemptNumber Int
  answersJson   Json?
  score         Int?
  result        PressResult
  headline      String?
  subtitle      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  student    StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  submission Submission     @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  quiz       PressQuiz      @relation(fields: [pressQuizId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([pressQuizId])
  @@index([result])
}

//
// TOUR / STREAK
//

model Tour {
  id        String     @id @default(uuid())
  studentId String
  seasonId  String
  name      String
  description String?
  requiredStreak Int  @default(7)
  status    TourStatus
  completed Boolean    @default(false)
  startedAt DateTime
  endedAt   DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  season  Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  days    StreakDay[]
  shows   TourShow[]

  @@unique([studentId, seasonId])
}

model TourShow {
  id         String   @id @default(uuid())
  tourId     String
  city       String
  venue      String
  date       DateTime
  checkedIn  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
}

model StreakDay {
  id     String          @id @default(uuid())
  tourId String
  date   DateTime        @db.Date
  status StreakDayStatus
  createdAt DateTime     @default(now())

  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([tourId, date])
}

//
// VACATION / LEAVE
//

model Vacation {
  id        String   @id @default(uuid())
  studentId String
  seasonId  String
  startDate DateTime
  endDate   DateTime
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  season  Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
}

//
// FAN ENGINE
//

model FanRule {
  id        String       @id @default(uuid())
  eventType String       @unique
  effect    StreakEffect
  points    Int
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([eventType])
}

model FanTransaction {
  id        String   @id @default(uuid())
  studentId String
  seasonId  String
  eventId   String
  amount    Int
  reason    String
  createdAt DateTime @default(now())

  student StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  season  Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  event   DomainEvent    @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model Career {
  id                String       @id @default(uuid())
  studentId         String
  seasonId          String
  fans              Int          @default(0)
  level             ArtistLevel  @default(SHOWER)
  levelNumber       Int          @default(1)
  currentStreak     Int          @default(0)
  longestStreak     Int          @default(0)
  totalDemos        Int          @default(0)
  approvedDemos     Int          @default(0)
  totalAchievements Int          @default(0)
  toursCompleted    Int          @default(0)
  lastActiveDate    DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  season  Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([studentId, seasonId])
  @@index([fans])
  @@index([level])
  @@index([currentStreak])
}

//
// ACHIEVEMENTS
//

model Achievement {
  id          String              @id @default(uuid())
  title       String
  description String
  icon        String
  category    AchievementCategory
  tier        AchievementTier
  requirement Int
  fansReward  Int
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  students StudentAchievement[]

  @@index([category])
  @@index([tier])
}

model StudentAchievement {
  id            String    @id @default(uuid())
  studentId     String
  achievementId String
  unlocked      Boolean   @default(false)
  unlockedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  student     StudentProfile @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  achievement Achievement    @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
  @@index([studentId, unlocked])
}

//
// NOTIFICATION
//

model Notification {
  id         String    @id @default(uuid())
  userId     String
  type       String    // Ex: 'REVIEW_RECEIVED', 'PRESS_UNLOCKED', 'TOUR_REMINDER'
  title      String    // T√≠tulo da notifica√ß√£o (vem do backend)
  message    String    // Mensagem da notifica√ß√£o (vem do backend)
  icon       String?   // √çcone opcional (ex: 'üéâ', '‚ö†Ô∏è')
  color      String?   // Cor opcional (ex: 'red', 'blue', 'green')
  
  // Deep Link System (IMPORTANTE!)
  sourceType String?   // Ex: 'SUBMISSION', 'REVIEW', 'PROJECT', 'TRACK_SCENE', 'PRESS_QUIZ'
  sourceId   String?   // ID da entidade origem (ex: submissionId, reviewId, projectId)
  actionUrl  String?   // URL de a√ß√£o customizada (ex: '/estudio/submission/sub-123')
  
  // COMO FUNCIONA O DEEP LINK:
  // 1. Backend cria notifica√ß√£o com sourceType + sourceId
  // 2. Opcionalmente inclui actionUrl customizada
  // 3. Frontend parseia com utils/deeplink.ts
  // 4. Navega para contexto espec√≠fico com par√¢metros
  //
  // Exemplos:
  // - sourceType: 'REVIEW', sourceId: 'review-123' ‚Üí Est√∫dio com review espec√≠fica
  // - sourceType: 'PROJECT', sourceId: 'proj-456' ‚Üí Projetos com projeto aberto
  // - actionUrl: '/estudio/submission/sub-123/review/rev-456' ‚Üí Navega√ß√£o direta
  
  readAt     DateTime? // null = n√£o lida, preenchida = lida
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@index([userId, createdAt])
  @@index([sourceType, sourceId])
}

//
// DOMAIN EVENT (AUDIT CORE)
//

model DomainEvent {
  id                String         @id @default(uuid())
  type              String
  actorId           String
  actorType         ActorType
  targetType        String
  targetId          String
  metadata          Json?
  processingVersion Int            @default(1)
  processedAt       DateTime?
  createdAt         DateTime       @default(now())

  actor User?              @relation("ActorEvents", fields: [actorId], references: [id], onDelete: SetNull)
  fanTransactions FanTransaction[]

  @@index([type])
  @@index([actorId])
  @@index([targetType, targetId])
  @@index([processedAt])
  @@index([createdAt])
}

//
// TEST TABLE (para testar migrations autom√°ticas)
//

model TestTable {
  id        String   @id @default(uuid())
  name      String
  value     Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}
